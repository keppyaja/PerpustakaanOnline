<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perpusri — Beranda</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="styles.css">
    <script src="auth.js"></script>
    <script>
        if (!isAuthenticated()) {
            // redirect ke halaman login jika tidak ada sesi
            window.location.replace('login.html');
        }
    </script>
</head>
<body>
    <div class="user-view">
        <header class="navbar">
            <div class="logo">Perpusri</div>
            <nav>
                <a href="index.html">Home</a>
                <a href="buku.html">Buku</a>
                <a href="jurnal.html">Jurnal</a>
                <a href="skripsi.html">Skripsi</a>
                <a href="tesis.html">Tesis</a>
                <a href="disertasi.html">Disertasi</a>
                <a href="forum.html">Forum</a>
                <a href="profil.html">Profil</a>
            </nav>
            <div class="profile-icon" id="profileIcon" style="width:36px;height:36px;">
                <img id="profileAvatar" src="" alt="avatar" style="width:36px;height:36px;border-radius:50%;object-fit:cover;display:none;">
                <div id="profileInitial" style="width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#ddd;font-weight:700;color:#333;">D</div>
            </div>
        </header>

        <main>
            <section class="search-section">
                <div class="search-bar-container">
                    <input type="text" placeholder="Cari Jurnal, Buku, Penelitian...">
                    <button class="search-button"><i class="fas fa-search"></i></button>
                </div>
                <div class="filter-bar">
                    <a class="category-pill" href="buku.html"><i class="fas fa-book"></i> Buku</a>
                    <a class="category-pill" href="jurnal.html">Jurnal</a>
                    <a class="category-pill" href="skripsi.html">Skripsi</a>
                    <a class="category-pill" href="tesis.html">Tesis</a>
                    <a class="category-pill" href="disertasi.html">Disertasi</a>
                </div>
            </section>

            <section class="welcome-banner">
                <h1>Selamat datang di<br>Perpustakaan Riset Online</h1>
                <p>Akses ribuan jurnal, buku, dan penelitian terkini. Temukan pengetahuan yang Anda butuhkan untuk penelitian dan pembelajaran.</p>
            </section>

            <section class="features-section">
                <h2 style="text-align: center; margin-bottom: 10px;">Fitur Sistem</h2>
                <p style="text-align: center; color: var(--color-text-light);">Apa yang dapat Anda lakukan di sini?</p>
                
                <div class="features-grid">
                    <div class="feature-card">
                        <i class="fas fa-search"></i>
                        <h3>Pencarian Cepat</h3>
                        <p>Pencarian cepat berdasarkan judul, penulis, atau kata kunci.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-sliders-h"></i>
                        <h3>Eksplorasi Mudah</h3>
                        <p>Kategori dan filter untuk memudahkan eksplorasi.</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-user-circle"></i>
                        <h3>Manajemen Akun</h3>
                        <p>Manajemen akun (registrasi, login, profil pengguna).</p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-tools"></i>
                        <h3>Dashboard Admin</h3>
                        <p><a href="admin.html">Masuk ke panel admin</a></p>
                    </div>
                    <div class="feature-card">
                        <i class="fas fa-chart-line"></i>
                        <h3>Statistik</h3>
                        <p>Statistik penggunaan untuk memantau akses koleksi.</p>
                    </div>
                </div>
            </section>

            <section class="section-content">
                <h2>Rekomendasi untuk Anda</h2>
                <div class="card-container">
                    <div class="document-card">
                        <div class="card-image-placeholder"><i class="far fa-file-alt"></i></div>
                        <div class="card-content">
                            <span class="doc-type">Artikel</span>
                            <h3>Judul Artikel</h3>
                            <p>Penulis • Tahun</p>
                            <button class="read-button">Baca Sekarang</button>
                        </div>
                    </div>
                    <div class="document-card">
                        <div class="card-image-placeholder"><i class="far fa-file-alt"></i></div>
                        <div class="card-content">
                            <span class="doc-type">Buku</span>
                            <h3>Contoh Buku</h3>
                            <p>Penulis • Tahun</p>
                            <button class="read-button">Baca Sekarang</button>
                        </div>
                    </div>
                    <div class="document-card">
                        <div class="card-image-placeholder"><i class="far fa-file-alt"></i></div>
                        <div class="card-content">
                            <span class="doc-type">Skripsi</span>
                            <h3>Contoh Skripsi</h3>
                            <p>Penulis • Tahun</p>
                            <button class="read-button">Baca Sekarang</button>
                        </div>
                    </div>
                </div>
            </section>

            <section class="section-content">
                <h2>Kategori Populer</h2>
                <div class="category-grid">
                    <a class="category-item blue" href="buku.html">
                        <i class="fas fa-book fa-2x"></i>
                        <h4>Buku</h4>
                        <p><span id="count_buku">0</span> dokumen</p>
                    </a>
                    <a class="category-item green" href="jurnal.html">
                        <i class="fas fa-file-alt fa-2x"></i>
                        <h4>Jurnal</h4>
                        <p><span id="count_jurnal">0</span> dokumen</p>
                    </a>
                    <a class="category-item purple" href="skripsi.html">
                        <i class="fas fa-graduation-cap fa-2x"></i>
                        <h4>Skripsi</h4>
                        <p><span id="count_skripsi">0</span> dokumen</p>
                    </a>
                    <a class="category-item orange" href="tesis.html">
                        <i class="fas fa-scroll fa-2x"></i>
                        <h4>Tesis</h4>
                        <p><span id="count_tesis">0</span> dokumen</p>
                    </a>
                    <a class="category-item red" href="disertasi.html">
                        <i class="fas fa-file-invoice fa-2x"></i>
                        <h4>Disertasi</h4>
                        <p><span id="count_disertasi">0</span> dokumen</p>
                    </a>
                </div>
            </section>
            <!-- ...existing code... -->
            </section>

            <!-- Upload Section: unggah file dari kategori apa pun -->
            <section class="section-content">
                <h2>Unggah Dokumen</h2>
                <p style="color:var(--color-text-light)">Unggah file penelitian (PDF/DOCX/TXT). File disimpan untuk demo di localStorage (base64 jika <= limit).</p>

                <div class="card" style="margin-top:12px;">
                    <!-- Tampilan jumlah jurnal terunggah (realtime) -->
                    <div style="margin-bottom:10px;">
                        <strong>Jumlah Jurnal Terunggah:</strong>
                        <span id="countJurnalTotal">0</span>
                    </div>

                    <label>Judul</label>
                    <input id="uploadTitle" placeholder="Judul dokumen" style="width:100%; padding:10px; margin:8px 0;">

                    <label>Kategori</label>
                    <select id="uploadCategory" style="width:100%; padding:10px; margin:8px 0;">
                        <option value="jurnal">Jurnal</option>
                        <option value="buku">Buku</option>
                        <option value="artikel">Artikel</option>
                        <option value="skripsi">Skripsi</option>
                        <option value="tesis">Tesis</option>
                        <option value="disertasi">Disertasi</option>
                    </select>

                    <label>File</label>
                    <input id="uploadFile" type="file" accept=".pdf,.doc,.docx,.txt" style="width:100%; margin:8px 0;">

                    <div style="display:flex; gap:8px; align-items:center;">
                        <button id="uploadBtn" class="read-button">Unggah</button>
                        <button id="clearUploadBtn" style="background:#eee; border:none; padding:8px; border-radius:6px;">Bersihkan</button>
                        <div id="uploadStatus" style="color:var(--color-text-light); margin-left:10px;"></div>
                    </div>
                </div>

                <div class="card" style="margin-top:12px;">
                    <h3>Daftar Unggahan Terakhir</h3>
                    <div id="myUploadsList"></div>
                </div>
            </section>
<!-- ...existing code... -->

    <script>
        // --- Upload helper + storage (client-side demo) ---
        const KEY_COLL = 'perpusri_collections';
        const MAX_FILE_BYTES = 5 * 1024 * 1024; // 5MB limit for base64 storage demo
        const ALLOWED_MIME = [
            'application/pdf',
            'application/msword',
            'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
            'text/plain'
        ];

        function sanitizeInput(s){ return String(s||'').trim().replace(/[<>]/g,''); }
        function loadCollections(){ return JSON.parse(localStorage.getItem(KEY_COLL) || '[]'); }
        function saveCollections(arr){ localStorage.setItem(KEY_COLL, JSON.stringify(arr)); }

        // Hitung dan tampilkan jumlah dokumen per kategori secara realtime
        function updateCategoryCounts(){
            const arr = loadCollections();
            const counts = arr.reduce((acc, it) => {
                const t = (String(it.type||'')).toLowerCase();
                acc.total = (acc.total||0) + 1;
                acc[t] = (acc[t]||0) + 1;
                return acc;
            }, {});
            // map ke elemen UI (fallback ke 0)
            const map = {
                'buku': 'count_buku',
                'jurnal': 'count_jurnal',
                'skripsi': 'count_skripsi',
                'tesis': 'count_tesis',
                'disertasi': 'count_disertasi'
            };
            Object.keys(map).forEach(k=>{
                const el = document.getElementById(map[k]);
                if (el) el.textContent = counts[k] || 0;
            });
            // juga update upload panel total jurnal (jika ada)
            const jurnalTotalEl = document.getElementById('countJurnalTotal');
            if (jurnalTotalEl) jurnalTotalEl.textContent = counts['jurnal'] || 0;
            // update publikasi saya jika elemen ada
            const session = (typeof getSession === 'function') ? getSession() : null;
            if (session) {
                const myCount = arr.filter(it => String(it.authorEmail||'').toLowerCase() === String(session.email||'').toLowerCase()).length;
                const myEl = document.getElementById('countMyPubl');
                if (myEl) myEl.textContent = myCount;
            }
        }

        function fileToBase64(file){
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result.split(',')[1]); // base64 data
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function handleUpload(){
            const session = (typeof getSession === 'function') ? getSession() : null;
            if (!session) { alert('Silakan login terlebih dahulu.'); window.location.href='login.html'; return; }

            const title = sanitizeInput(document.getElementById('uploadTitle').value);
            const category = sanitizeInput(document.getElementById('uploadCategory').value);
            const fileInput = document.getElementById('uploadFile');
            const file = fileInput.files && fileInput.files[0];
            const status = document.getElementById('uploadStatus');

            status.textContent = '';
            if (!title) { status.style.color='red'; status.textContent = 'Judul wajib diisi.'; return; }
            if (!file) { status.style.color='red'; status.textContent = 'Pilih file untuk diunggah.'; return; }
            if (!ALLOWED_MIME.includes(file.type)) { status.style.color='red'; status.textContent = 'Tipe file tidak didukung.'; return; }

            // meta
            const meta = {
                id: Date.now(),
                title,
                type: category,
                authorEmail: session.email,
                year: new Date().getFullYear(),
                fileName: file.name,
                fileMime: file.type,
                createdAt: new Date().toISOString()
            };

            if (file.size <= MAX_FILE_BYTES) {
                status.style.color = 'var(--color-text-light)';
                status.textContent = 'Mengonversi file...';
                try {
                    const base64 = await fileToBase64(file);
                    meta.fileBase64 = base64.slice(0, 20000000); // safety cap
                } catch(e){
                    status.style.color='red';
                    status.textContent='Gagal membaca file.';
                    return;
                }
            } else {
                status.style.color='var(--color-text-light)';
                status.textContent = 'File terlalu besar untuk disimpan sebagai base64; hanya metadata disimpan.';
            }

            const arr = loadCollections();
            arr.push(meta);
            saveCollections(arr);

            status.style.color='green';
            status.textContent = 'Unggah berhasil.';
            document.getElementById('uploadTitle').value='';
            document.getElementById('uploadFile').value='';
            renderMyUploads();
            updateCategoryCounts(); // update realtime setelah unggah
        }

        function renderMyUploads(){
            const session = (typeof getSession === 'function') ? getSession() : null;
            if (!session) return;
            const list = loadCollections().filter(c => String(c.authorEmail||'').toLowerCase() === session.email.toLowerCase());
            const container = document.getElementById('myUploadsList');
            if (!container) return;
            if (list.length === 0) { container.innerHTML = '<p>Tidak ada unggahan.</p>'; return; }
            container.innerHTML = '';
            list.slice().reverse().forEach(it => {
                const el = document.createElement('div');
                el.className = 'report-card';
                el.style.marginBottom = '8px';
                el.innerHTML = `<div style="display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <strong>${it.title}</strong> <div style="color:var(--color-text-light)">${it.type} — ${it.fileName || ''}</div>
                    </div>
                    <div style="display:flex; gap:8px; align-items:center;">
                        ${it.fileBase64 ? `<a href="data:${it.fileMime};base64,${it.fileBase64}" download="${it.fileName}" style="padding:8px; background:#e6f7ff; text-decoration:none; border-radius:6px;">Unduh</a>` : ''}
                        <button data-id="${it.id}" class="btnDeleteUpload" style="padding:6px 10px; background:#f8d7da; border:none;">Hapus</button>
                    </div>
                </div>`;
                container.appendChild(el);
            });

            container.querySelectorAll('.btnDeleteUpload').forEach(b => b.addEventListener('click', (e)=>{
                const id = e.currentTarget.dataset.id;
                if (!confirm('Hapus unggahan ini?')) return;
                const arr = loadCollections().filter(x => String(x.id) !== String(id));
                saveCollections(arr);
                renderMyUploads();
                updateCategoryCounts(); // update realtime setelah hapus
            }));
        }

        // safe attach: ensure elements exist before binding
        function safeInit(){
            const uploadBtn = document.getElementById('uploadBtn');
            if (uploadBtn) uploadBtn.addEventListener('click', handleUpload);
            const clearBtn = document.getElementById('clearUploadBtn');
            if (clearBtn) clearBtn.addEventListener('click', ()=>{
                const ut = document.getElementById('uploadTitle'); if (ut) ut.value='';
                const uf = document.getElementById('uploadFile'); if (uf) uf.value='';
                const us = document.getElementById('uploadStatus'); if (us) us.textContent='';
            });

            // update realtime jika ada perubahan localStorage dari tab lain
            let storageDebounce = 0;
            window.addEventListener('storage', (ev) => {
                if (ev.key === KEY_COLL) {
                    clearTimeout(storageDebounce);
                    storageDebounce = setTimeout(()=> {
                        updateCategoryCounts();
                        renderMyUploads();
                    }, 120);
                }
            });

            // initial render (call regardless of auth state to keep UI consistent)
            updateCategoryCounts();
            if (typeof isAuthenticated === 'function' && isAuthenticated()) {
                renderMyUploads();
            }
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', safeInit);
        } else {
            safeInit();
        }
    </script>

    <script>
        // Add reveal class to common UI blocks and observe them to animate on scroll
        (function(){
            const SELECTORS = 'header, section, .card, .report-card, .feature-card, .stat-card, .document-card';
            function addReveals(){
                document.querySelectorAll(SELECTORS).forEach(el=>{
                    // avoid duplicating
                    if (!el.classList.contains('reveal') && !el.classList.contains('stagger')) {
                        el.classList.add('reveal');
                    }
                });
                // mark common lists as stagger containers
                document.querySelectorAll('.features-grid, .card-container, .stats-grid, .card .list, #collectionsList, #usersList, #warningsList').forEach(c=>{
                    if (!c.classList.contains('stagger')) c.classList.add('stagger');
                });
            }

            function observeReveals(){
                const obs = new IntersectionObserver((entries)=>{
                    entries.forEach(entry=>{
                        if (!entry.target) return;
                        if (entry.isIntersecting) {
                            entry.target.classList.add('reveal-visible');
                        } else {
                            entry.target.classList.remove('reveal-visible');
                        }
                    });
                }, {
                    threshold: 0.1 // trigger when 10% visible
                });
                document.querySelectorAll('.reveal').forEach(el=>obs.observe(el));
            }

            // init
            addReveals();
            observeReveals();
        })();
    </script>

    <!-- set profile icon -->
    <script src="set-profile.js"></script>
</body>
</html>